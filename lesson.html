<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Lesson â€“ DeutschFast</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Global styles -->
  <link rel="stylesheet" href="css/style.css" />
  <!-- Lesson specific styles -->
  <link rel="stylesheet" href="css/lesson.css" />
</head>
<body>
  <div class="page lesson-page">
    <!-- Header -->
    <header class="header">
      <div class="logo">DeutschFast</div>
      <nav class="nav-links">
        <a href="dashboard.html">Dashboard</a>
        <a href="courses.html">Courses</a>
        <a href="#" class="nav-link active">Lesson</a>
        <a href="vocab.html">Vocab</a>
        <a href="#">Profile</a>
        <a href="login.html" class="nav-link logout-link">Log out</a>
      </nav>
    </header>

    <!-- Main content -->
    <main class="lesson-main">
      <!-- Lesson header (will be populated dynamically) -->
      <section class="lesson-hero">
        <h1 class="lesson-title" id="lesson-title">Loading...</h1>
        <p class="lesson-subtitle" id="lesson-subtitle">
          Practice listening, reading, speaking, and writing.
        </p>
        <span class="lesson-pill" id="lesson-pill">Lesson 1 of 5</span>
      </section>

      <!-- Lesson overview / explanation -->
      <section class="lesson-overview">
        <h2 class="lesson-overview-title">Today's focus</h2>
        <p class="lesson-overview-text" id="lesson-focus">
          Loading lesson content...
        </p>
        <p class="lesson-overview-text" id="lesson-instructions">
        </p>
      </section>

      <!-- Two-column grid: Listening + Reading, Speaking + Writing -->
      <section class="lesson-grid">
        <!-- Listening -->
        <article class="lesson-card">
          <h2 class="lesson-card-title">Listening</h2>
          <p class="lesson-card-sub" id="listening-subtitle">Listen to the dialogue and answer the questions.</p>

          <!-- Audio player -->
          <div class="audio-player">
            <button class="audio-play-btn" id="audio-play-btn">â–¶</button>
            <div class="audio-bar">
              <span class="audio-progress" id="audio-progress"></span>
            </div>
            <span class="audio-time" id="audio-time">0:00 / 0:00</span>
          </div>
          
          <!-- Hidden audio element -->
          <audio id="lesson-audio" style="display: none;">
            <source id="audio-source" src="" type="audio/mpeg">
          </audio>

          <!-- One-question-at-a-time quiz -->
          <div id="listening-quiz">
            <p id="listening-question-text" class="question-text"></p>
            <div id="listening-options"></div>

            <div class="quiz-nav">
              <button id="listening-prev" class="btn-quiz" disabled>Previous</button>
              <span id="listening-progress" class="quiz-progress"></span>
              <button id="listening-next" class="btn-quiz">Next</button>
            </div>
          </div>
        </article>

        <!-- Reading -->
        <article class="lesson-card">
          <h2 class="lesson-card-title">Reading</h2>
          <p class="lesson-card-sub" id="reading-subtitle">Read the text and answer the questions.</p>

          <div class="reading-text" id="reading-text">
            Loading text...
          </div>

          <!-- One-question-at-a-time quiz -->
          <div id="reading-quiz">
            <p id="reading-question-text" class="question-text"></p>
            <div id="reading-options"></div>

            <div class="quiz-nav">
              <button id="reading-prev" class="btn-quiz" disabled>Previous</button>
              <span id="reading-progress" class="quiz-progress"></span>
              <button id="reading-next" class="btn-quiz">Next</button>
            </div>
          </div>
        </article>

        <!-- Speaking -->
        <article class="lesson-card">
          <h2 class="lesson-card-title">Speaking</h2>
          <p class="lesson-card-sub" id="speaking-subtitle">
            Introduce yourself in German. Say your name, age, and where you are from.
          </p>

          <div class="record-wrapper">
            <button class="record-btn">
              <span class="record-icon">ðŸŽ™</span>
            </button>
            <p class="record-label">Record</p>
          </div>

          <p class="record-help" id="speaking-prompt">
            Click record and speak for 30â€“60 seconds.
          </p>
        </article>

        <!-- Writing -->
        <article class="lesson-card">
          <h2 class="lesson-card-title">Writing</h2>
          <p class="lesson-card-sub" id="writing-subtitle">
            Write 3â€“5 sentences about yourself in German. Use the new words you learned.
          </p>

          <textarea
            class="writing-textarea"
            id="writing-textarea"
            placeholder="Schreiben Sie hier Ihre Antwort..."
          ></textarea>

          <p class="writing-help" id="writing-prompt">
            Use at least 3 of today's new words.
          </p>
        </article>
      </section>

      <!-- Complete button -->
      <section class="lesson-cta-section">
        <button class="btn btn-primary lesson-cta-btn" id="complete-lesson-btn">
          Complete Lesson
        </button>
      </section>
    </main>

    <!-- Footer -->
    <footer class="footer">
      <div>DeutschFast</div>
      <div class="footer-links">
        <a href="#">Contact</a>
        <a href="#">Privacy Policy</a>
        <a href="#">Terms of Use</a>
      </div>
    </footer>
  </div>

  <!-- Dynamic lesson script -->
  <script>
  // ========================================
  // GLOBAL VARIABLES
  // ========================================

  let currentLesson = null;
  let listeningQuestions = [];
  let readingQuestions = [];
  
  // âœ… FIX: Declare sectionCompletion BEFORE validation functions
  let sectionCompletion = {
    listening: false,
    reading: false,
    speaking: false,
    writing: false
  };

  // ========================================
  // LESSON LOADER
  // ========================================

  // Get lesson ID from URL parameter
  function getLessonId() {
    const params = new URLSearchParams(window.location.search);
    return params.get('id') || 'lesson-1-1'; // Default to first lesson
  }

  // Load lesson data from JSON
  async function loadLesson() {
    const lessonId = getLessonId();
    
    try {
      const response = await fetch('data/lessons.json');
      const data = await response.json();
      const lesson = data.lessons.find(l => l.id === lessonId);
      
      if (!lesson) {
        alert('Lesson not found');
        window.location.href = 'courses.html';
        return;
      }
      
      currentLesson = lesson;
      renderLesson(lesson);
      
    } catch (error) {
      console.error('Error loading lesson:', error);
      alert('Error loading lesson. Please try again.');
    }
  }

  // Render lesson content
  function renderLesson(lesson) {
    // Update header
    document.getElementById('lesson-title').textContent = 
      `${lesson.level} Â· ${lesson.category} â€“ Lesson ${lesson.lessonNumber}: ${lesson.title}`;
    document.getElementById('lesson-pill').textContent = 
      `Lesson ${lesson.lessonNumber} of ${lesson.totalLessons}`;
    
    // Update focus section
    document.getElementById('lesson-focus').textContent = lesson.focus;
    document.getElementById('lesson-instructions').textContent = lesson.instructions;
    
    // Update listening section
    document.getElementById('listening-subtitle').textContent = lesson.listening.subtitle;
    document.getElementById('audio-source').src = lesson.listening.audioFile;
    document.getElementById('audio-time').textContent = `0:00 / ${lesson.listening.duration}`;
    document.getElementById('lesson-audio').load();
    listeningQuestions = lesson.listening.questions;
    
    // Update reading section
    document.getElementById('reading-subtitle').textContent = lesson.reading.subtitle;
    document.getElementById('reading-text').textContent = lesson.reading.text;
    readingQuestions = lesson.reading.questions;
    
    // Update speaking section
    document.getElementById('speaking-subtitle').textContent = lesson.speaking.subtitle;
    document.getElementById('speaking-prompt').textContent = lesson.speaking.prompt;
    
    // Update writing section
    document.getElementById('writing-subtitle').textContent = lesson.writing.subtitle;
    document.getElementById('writing-prompt').textContent = lesson.writing.prompt;
    document.getElementById('writing-textarea').placeholder = lesson.writing.placeholder;
    
    // Initialize quizzes
    initQuizzes();
    
    // âœ… FIX: Initialize audio, recording, and writing validation AFTER DOM is populated
    initAudioAndRecording();
    initWritingValidation();
  }

  // Initialize quizzes after lesson loads
  function initQuizzes() {
    setupMiniQuiz({
      questions: listeningQuestions,
      questionTextEl: document.getElementById("listening-question-text"),
      optionsContainer: document.getElementById("listening-options"),
      prevBtn: document.getElementById("listening-prev"),
      nextBtn: document.getElementById("listening-next"),
      progressEl: document.getElementById("listening-progress"),
      namePrefix: "listen-q-"
    });

    setupMiniQuiz({
      questions: readingQuestions,
      questionTextEl: document.getElementById("reading-question-text"),
      optionsContainer: document.getElementById("reading-options"),
      prevBtn: document.getElementById("reading-prev"),
      nextBtn: document.getElementById("reading-next"),
      progressEl: document.getElementById("reading-progress"),
      namePrefix: "read-q-"
    });
  }

  // ========================================
  // QUIZ LOGIC
  // ========================================

  function setupMiniQuiz(config) {
    const {
      questions,
      questionTextEl,
      optionsContainer,
      prevBtn,
      nextBtn,
      progressEl,
      namePrefix
    } = config;

    let index = 0;

    function render() {
      const q = questions[index];
      questionTextEl.textContent = q.text;

      optionsContainer.innerHTML = "";
      q.options.forEach((opt) => {
        const label = document.createElement("label");
        label.className = "option";

        const input = document.createElement("input");
        input.type = "radio";
        input.name = namePrefix + index;
        input.value = opt;

        label.appendChild(input);
        label.appendChild(document.createTextNode(" " + opt));
        optionsContainer.appendChild(label);
      });

      progressEl.textContent = `Question ${index + 1} of ${questions.length}`;
      prevBtn.disabled = index === 0;
      nextBtn.disabled = index === questions.length - 1;
    }

    prevBtn.addEventListener("click", () => {
      if (index > 0) {
        index--;
        render();
      }
    });

    nextBtn.addEventListener("click", () => {
      if (index < questions.length - 1) {
        index++;
        render();
      } else {
        // Last question - check if section is complete
        if (namePrefix === 'listen-q-') {
          checkListeningComplete();
        } else if (namePrefix === 'read-q-') {
          checkReadingComplete();
        }
      }
    });

    // Initial render
    render();
  }

  // ========================================
  // SECTION VALIDATION FUNCTIONS
  // ========================================

  // Mark listening section as complete when all questions answered
  function checkListeningComplete() {
    const totalQuestions = listeningQuestions.length;
    let answeredCount = 0;
    
    for (let i = 0; i < totalQuestions; i++) {
      const answered = document.querySelector(`input[name="listen-q-${i}"]:checked`);
      if (answered) answeredCount++;
    }
    
    if (answeredCount === totalQuestions) {
      sectionCompletion.listening = true;
      document.querySelector('.lesson-card:nth-child(1) .lesson-card-title').textContent = 'Listening âœ“';
      console.log('âœ… Listening section completed');
    }
  }

  // Mark reading section as complete when all questions answered
  function checkReadingComplete() {
    const totalQuestions = readingQuestions.length;
    let answeredCount = 0;
    
    for (let i = 0; i < totalQuestions; i++) {
      const answered = document.querySelector(`input[name="read-q-${i}"]:checked`);
      if (answered) answeredCount++;
    }
    
    if (answeredCount === totalQuestions) {
      sectionCompletion.reading = true;
      document.querySelector('.lesson-card:nth-child(2) .lesson-card-title').textContent = 'Reading âœ“';
      console.log('âœ… Reading section completed');
    }
  }

  // Mark speaking as complete when recording is made
  function markSpeakingComplete() {
    sectionCompletion.speaking = true;
    document.querySelector('.lesson-card:nth-child(3) .lesson-card-title').textContent = 'Speaking âœ“';
    console.log('âœ… Speaking section completed');
  }

  // Mark writing as complete when text is entered
  function checkWritingComplete() {
    const text = document.getElementById('writing-textarea').value.trim();
    if (text.length >= 20) {
      sectionCompletion.writing = true;
      document.querySelector('.lesson-card:nth-child(4) .lesson-card-title').textContent = 'Writing âœ“';
      console.log('âœ… Writing section completed');
      return true;
    }
    return false;
  }

  // âœ… FIX: Initialize writing validation AFTER DOM loads
  function initWritingValidation() {
    document.getElementById('writing-textarea').addEventListener('input', checkWritingComplete);
  }

  // ========================================
  // AUDIO PLAYER & RECORDING LOGIC
  // ========================================

  function initAudioAndRecording() {
    // Audio player setup
    const audioElement = document.getElementById('lesson-audio');
    const playBtn = document.getElementById('audio-play-btn');
    const progressBar = document.getElementById('audio-progress');
    const timeDisplay = document.getElementById('audio-time');

    playBtn.addEventListener('click', () => {
      if (audioElement.paused) {
        audioElement.play();
        playBtn.textContent = 'â¸';
      } else {
        audioElement.pause();
        playBtn.textContent = 'â–¶';
      }
    });

    audioElement.addEventListener('timeupdate', () => {
      const percent = (audioElement.currentTime / audioElement.duration) * 100;
      progressBar.style.width = percent + '%';
      
      const currentMin = Math.floor(audioElement.currentTime / 60);
      const currentSec = Math.floor(audioElement.currentTime % 60).toString().padStart(2, '0');
      const durationMin = Math.floor(audioElement.duration / 60);
      const durationSec = Math.floor(audioElement.duration % 60).toString().padStart(2, '0');
      
      timeDisplay.textContent = `${currentMin}:${currentSec} / ${durationMin}:${durationSec}`;
    });

    audioElement.addEventListener('ended', () => {
      playBtn.textContent = 'â–¶';
      progressBar.style.width = '0%';
    });

    // Recording setup
    const recordBtn = document.querySelector(".record-btn");
    const recordLabel = document.querySelector(".record-label");
    let mediaRecorder;
    let chunks = [];
    let isRecording = false;

    async function initMic() {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);

      mediaRecorder.ondataavailable = (e) => {
        chunks.push(e.data);
      };

      mediaRecorder.onstop = () => {
        const blob = new Blob(chunks, { type: "audio/webm" });
        chunks = [];
        const url = URL.createObjectURL(blob);
        const audio = new Audio(url);
        audio.play();
      };
    }

    recordBtn.addEventListener("click", async () => {
      try {
        if (!mediaRecorder) {
          await initMic();
        }

        if (!isRecording) {
          mediaRecorder.start();
          isRecording = true;
          recordLabel.textContent = "Recording...";
          recordBtn.classList.add("recording");
        } else {
          mediaRecorder.stop();
          isRecording = false;
          recordLabel.textContent = "Recorded âœ“";
          recordBtn.classList.remove("recording");
          markSpeakingComplete();
        }
      } catch (err) {
        console.error("Mic error:", err);
        alert("Could not access microphone.");
      }
    });
  }

  // ========================================
  // COMPLETE LESSON LOGIC WITH VALIDATION
  // ========================================

  document.getElementById('complete-lesson-btn').addEventListener('click', () => {
    if (!currentLesson) return;
    
    // Check if all sections are completed
    const completedSections = Object.values(sectionCompletion).filter(v => v).length;
    const totalSections = 4;
    
    if (completedSections < totalSections) {
      const missing = [];
      if (!sectionCompletion.listening) missing.push('Listening');
      if (!sectionCompletion.reading) missing.push('Reading');
      if (!sectionCompletion.speaking) missing.push('Speaking');
      if (!sectionCompletion.writing) missing.push('Writing');
      
      alert(`âš ï¸ Please complete all sections before finishing the lesson!\n\nMissing: ${missing.join(', ')}`);
      return;
    }
    
    // All sections completed - proceed
    const progress = JSON.parse(localStorage.getItem('moduleProgress')) || {};
    const moduleId = currentLesson.moduleId;
    
    if (!progress[moduleId]) {
      progress[moduleId] = { completedLessons: 0 };
    }
    
    if (progress[moduleId].completedLessons < currentLesson.lessonNumber) {
      progress[moduleId].completedLessons = currentLesson.lessonNumber;
    }
    
    localStorage.setItem('moduleProgress', JSON.stringify(progress));
    
    if (currentLesson.lessonNumber < currentLesson.totalLessons) {
      const nextLessonNum = currentLesson.lessonNumber + 1;
      const moduleNum = currentLesson.moduleId.split('-')[1] || '1';
      const nextLessonId = `lesson-${moduleNum}-${nextLessonNum}`;
      
      if (confirm('âœ… Lesson completed! Go to next lesson?')) {
        window.location.href = `lesson.html?id=${nextLessonId}`;
      } else {
        window.location.href = 'courses.html';
      }
    } else {
      alert('ðŸŽ‰ Module completed! Great job!');
      window.location.href = 'courses.html';
    }
  });

  // ========================================
  // INITIALIZE ON PAGE LOAD
  // ========================================

  loadLesson();
  </script>
</body>
</html>
