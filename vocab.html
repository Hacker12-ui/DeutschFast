<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Vocab Practice - DeutschFast</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Global styles -->
  <link rel="stylesheet" href="css/style.css" />
  <!-- Vocab specific styles -->
  <link rel="stylesheet" href="css/vocab.css" />
  <style>
    /* Speaker button styles */
    .speak-btn {
      background: none;
      border: none;
      font-size: 1.5em;
      cursor: pointer;
      padding: 5px;
      transition: transform 0.2s;
      opacity: 0.7;
    }
    .speak-btn:hover {
      transform: scale(1.2);
      opacity: 1;
    }
    .speak-btn:active {
      transform: scale(0.9);
    }
  </style>
</head>
<body>
  <div class="page vocab-page">
    <!-- Header -->
    <header class="header">
      <div class="logo">DeutschFast</div>
      <nav class="nav-links">
        <a href="dashboard.html">Dashboard</a>
        <a href="courses.html">Courses</a>
        <a href="lesson.html">Lessons</a>
        <a href="vocab.html" class="nav-link active">Vocab</a>
        <a href="#">Profile</a>
        <a href="login.html" class="nav-link logout-link">Log out</a>
      </nav>
    </header>

    <!-- Main content -->
    <main class="vocab-main">
      <!-- Page title -->
      <section class="vocab-hero">
        <h1 class="vocab-title">Vocab Practice</h1>
        <p class="vocab-subtitle">Review today's words with flashcards. <span id="vocab-level-badge" style="background: #667eea; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.9em; margin-left: 10px;">A1 Level - 926 Words</span></p>
      </section>

      <!-- Progress card -->
      <section class="vocab-progress-card">
        <div class="vocab-progress-header">
          <span class="vocab-progress-label">Today's words: <span id="current-word-num">1</span> / <span id="total-words">20</span></span>
        </div>
        <div class="vocab-progress-bar">
          <div id="vocab-progress-fill" class="vocab-progress-fill"></div>
        </div>
        <div class="vocab-stats">
          <span class="vocab-stat">Known: <span id="known-count">0</span></span>
          <span class="vocab-stat">Review: <span id="review-count">0</span></span>
        </div>
      </section>

      <!-- Flashcard -->
      <section class="flashcard-section">
        <div class="flashcard">
          <div class="flashcard-badge">
            Word <span id="card-index">1</span> of <span id="card-total">20</span>
            <span id="word-type-badge" style="margin-left: 10px; background: #48bb78; padding: 2px 8px; border-radius: 12px; font-size: 0.85em;"></span>
          </div>
          
          <!-- German word with speaker button -->
          <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
            <div class="flashcard-word" id="flashcard-word">Loading...</div>
            <button id="speakWord" class="speak-btn" title="Hear pronunciation">ğŸ”Š</button>
          </div>
          
          <div class="flashcard-translation" id="flashcard-translation"></div>
          <div class="flashcard-divider"></div>
          
          <!-- Example sentence with speaker button -->
          <div style="display: flex; align-items: flex-start; gap: 10px;">
            <div class="flashcard-example" id="flashcard-example" style="flex: 1;"></div>
            <button id="speakExample" class="speak-btn" title="Hear example" style="flex-shrink: 0; margin-top: 0;">ğŸ”Š</button>
          </div>
          
          <div class="flashcard-icon">ğŸ“–</div>
        </div>
      </section>

      <!-- Action buttons -->
      <section class="vocab-actions">
        <button class="btn btn-forgot" id="btn-forgot">I forgot</button>
        <button class="btn btn-primary btn-knew" id="btn-knew">I knew it</button>
      </section>

      <p class="vocab-hint">Your progress adapts based on your answers. Words you forget will appear again soon.</p>
    </main>

    <!-- Footer -->
    <footer class="footer">
      <div>DeutschFast</div>
      <div class="footer-links">
        <a href="#">Contact</a>
        <a href="#">Privacy Policy</a>
        <a href="#">Terms of Use</a>
      </div>
    </footer>
  </div>

  <!-- Load Vocabulary Service -->
  <script src="vocabulary.js"></script>

  <!-- Flashcard logic with A1 vocabulary -->
<script>
  // ========================================
  // SPACED REPETITION VOCABULARY SYSTEM
  // ========================================

  let allWords = [];
  let todayWords = [];
  let currentWordIndex = 0;
  let knownCount = 0;
  let reviewCount = 0;
  const dailyNewWords = 20; // New words per day
  const dailyReviewWords = 10; // Review words per day

  // DOM elements
  const wordEl = document.getElementById("flashcard-word");
  const translationEl = document.getElementById("flashcard-translation");
  const exampleEl = document.getElementById("flashcard-example");
  const cardIndexEl = document.getElementById("card-index");
  const cardTotalEl = document.getElementById("card-total");
  const currentWordNumEl = document.getElementById("current-word-num");
  const totalWordsEl = document.getElementById("total-words");
  const knownCountEl = document.getElementById("known-count");
  const reviewCountEl = document.getElementById("review-count");
  const progressFillEl = document.getElementById("vocab-progress-fill");
  const wordTypeBadgeEl = document.getElementById("word-type-badge");
  const btnForgot = document.getElementById("btn-forgot");
  const btnKnew = document.getElementById("btn-knew");

  // ========================================
  // TEXT-TO-SPEECH FUNCTIONALITY
  // ========================================
  
  // Function to speak German text
  function speakGerman(text) {
    // Cancel any ongoing speech
    window.speechSynthesis.cancel();
    
    // Create new utterance
    const utterance = new SpeechSynthesisUtterance(text);
    
    // Set language to German
    utterance.lang = 'de-DE';
    
    // Adjust speech parameters for learning
    utterance.rate = 0.85;  // Slightly slower for better comprehension
    utterance.pitch = 1.0;
    utterance.volume = 1.0;
    
    // Try to use a German voice
    const voices = window.speechSynthesis.getVoices();
    const germanVoice = voices.find(voice => 
      voice.lang === 'de-DE' || voice.lang === 'de_DE' || voice.lang.startsWith('de')
    );
    
    if (germanVoice) {
      utterance.voice = germanVoice;
    }
    
    // Speak the text
    window.speechSynthesis.speak(utterance);
  }
  
  // Load voices on page load
  window.speechSynthesis.getVoices();
  
  // Chrome requires voices to load asynchronously
  if (window.speechSynthesis.onvoiceschanged !== undefined) {
    window.speechSynthesis.onvoiceschanged = () => {
      window.speechSynthesis.getVoices();
    };
  }

  // ========================================
  // SPACED REPETITION INTERVALS (in days)
  // ========================================
  const intervals = [0, 1, 3, 7, 14, 30]; // Level 0-5

  // ========================================
  // LOAD WORD PROGRESS FROM LOCALSTORAGE
  // ========================================
  function getWordProgress() {
    const saved = localStorage.getItem('wordProgress');
    return saved ? JSON.parse(saved) : {};
  }

  function saveWordProgress(progress) {
    localStorage.setItem('wordProgress', JSON.stringify(progress));
  }

  // ========================================
  // GET TODAY'S DATE (YYYY-MM-DD)
  // ========================================
  function getToday() {
    return new Date().toISOString().split('T')[0];
  }

  // ========================================
  // ADD DAYS TO DATE
  // ========================================
  function addDays(dateStr, days) {
    const date = new Date(dateStr);
    date.setDate(date.getDate() + days);
    return date.toISOString().split('T')[0];
  }

  // ========================================
  // SELECT WORDS FOR TODAY
  // ========================================
  function selectTodayWords(allWords) {
    const progress = getWordProgress();
    const today = getToday();

    // 1. Get words due for review today
    const dueWords = allWords.filter(word => {
      const wordData = progress[word.id];
      if (!wordData) return false; // New word, not due
      return wordData.nextReview <= today && wordData.level < 5;
    }).slice(0, dailyReviewWords);

    // 2. Get new words (never seen before)
    const newWords = allWords.filter(word => !progress[word.id])
                              .slice(0, dailyNewWords);

    // 3. Combine: review words first, then new words
    return [...dueWords, ...newWords];
  }

  // ========================================
  // MARK WORD AS KNOWN
  // ========================================
  function markWordKnown(wordId) {
    const progress = getWordProgress();
    const today = getToday();

    if (!progress[wordId]) {
      // New word - start at level 1
      progress[wordId] = {
        level: 1,
        lastReview: today,
        nextReview: addDays(today, intervals[1]) // Review in 1 day
      };
    } else {
      // Increase level
      const currentLevel = progress[wordId].level;
      const newLevel = Math.min(currentLevel + 1, 5);
      progress[wordId].level = newLevel;
      progress[wordId].lastReview = today;
      progress[wordId].nextReview = addDays(today, intervals[newLevel]);
    }

    saveWordProgress(progress);
  }

  // ========================================
  // MARK WORD AS FORGOTTEN
  // ========================================
  function markWordForgotten(wordId) {
    const progress = getWordProgress();
    const today = getToday();

    // Reset to level 0, show again soon
    progress[wordId] = {
      level: 0,
      lastReview: today,
      nextReview: today // Show again in this session
    };

    saveWordProgress(progress);
  }

  // ========================================
  // RENDER CURRENT FLASHCARD
  // ========================================
  function renderCard() {
    if (currentWordIndex >= todayWords.length) {
      showCompletionMessage();
      return;
    }

    const word = todayWords[currentWordIndex];
    const progress = getWordProgress();
    const wordData = progress[word.id];

    // Display word
    let displayWord = word.german;
    if (word.gender && !displayWord.toLowerCase().match(/^(der|die|das)\s/)) {
      const article = word.gender === 'm' ? 'der' : word.gender === 'f' ? 'die' : 'das';
      displayWord = `${article} ${word.german}`;
    }

    wordEl.textContent = displayWord;
    translationEl.textContent = word.english;

    // Show examples
    if (word.exampleDE && word.exampleEN) {
      exampleEl.innerHTML = `
        <div style="margin-bottom: 8px;"><strong>ğŸ‡©ğŸ‡ª</strong> ${word.exampleDE}</div>
        <div style="color: #666;"><strong>ğŸ‡¬ğŸ‡§</strong> ${word.exampleEN}</div>
      `;
    } else {
      exampleEl.textContent = word.exampleDE || '';
    }

    // Show word type and level as separate badges
    const levelBadge = wordData ? `Level ${wordData.level}` : 'New';
    wordTypeBadgeEl.innerHTML = `
      <span style="background: #48bb78; padding: 3px 10px; border-radius: 12px; font-size: 0.85em; margin-right: 8px;">
        ${word.wordType}
      </span>
      <span style="background: #fbbf24; color: #000; padding: 3px 10px; border-radius: 12px; font-size: 0.85em;">
        ${levelBadge}
      </span>
    `;

    // Update progress bar
    const progressPercent = ((currentWordIndex + 1) / todayWords.length) * 100;
    progressFillEl.style.width = Math.min(progressPercent, 100) + "%";

    // Update counters
    cardIndexEl.textContent = currentWordIndex + 1;
    cardTotalEl.textContent = todayWords.length;
    currentWordNumEl.textContent = currentWordIndex + 1;
    totalWordsEl.textContent = todayWords.length;
  }

  // ========================================
  // NEXT CARD
  // ========================================
  function nextCard() {
    currentWordIndex++;
    renderCard();
  }

  // ========================================
  // COMPLETION MESSAGE
  // ========================================
  function showCompletionMessage() {
    const progress = getWordProgress();
    const masteredCount = Object.values(progress).filter(w => w.level === 5).length;

    wordEl.textContent = "ğŸ‰ Great job!";
    translationEl.textContent = `You completed ${todayWords.length} words today`;
    exampleEl.innerHTML = `
      <div style="text-align: center; margin-top: 20px;">
        <p style="font-size: 1.2em; margin-bottom: 10px;">
          âœ“ Known: ${knownCount} | â†» Reviewed: ${reviewCount}
        </p>
        <p style="margin-bottom: 15px; color: #667eea; font-weight: bold;">
          ğŸ† Mastered Words: ${masteredCount} / 926
        </p>
        <button onclick="window.location.href='dashboard.html'" 
                style="padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1em;">
          Back to Dashboard
        </button>
      </div>
    `;
    wordTypeBadgeEl.textContent = '';
    
    // Hide the action buttons
    btnForgot.style.display = 'none';
    btnKnew.style.display = 'none';
    
    // Hide speaker buttons too
    document.getElementById('speakWord').style.display = 'none';
    document.getElementById('speakExample').style.display = 'none';
  }

  // ========================================
// BUTTON EVENT LISTENERS
// ========================================
btnKnew.addEventListener("click", () => {
  // Stop any ongoing speech
  window.speechSynthesis.cancel();
  
  const word = todayWords[currentWordIndex];
  markWordKnown(word.id);
  knownCount++;
  knownCountEl.textContent = knownCount;
  nextCard();
});

btnForgot.addEventListener("click", () => {
  // Stop any ongoing speech
  window.speechSynthesis.cancel();
  
  const word = todayWords[currentWordIndex];
  markWordForgotten(word.id);
  
  // Add word back to end of today's queue
  todayWords.push(word);
  
  reviewCount++;
  reviewCountEl.textContent = reviewCount;
  nextCard();
});


  // ========================================
  // TEXT-TO-SPEECH BUTTON LISTENERS
  // ========================================
  document.getElementById('speakWord').addEventListener('click', () => {
    const wordText = wordEl.textContent;
    if (wordText && wordText !== "Loading..." && wordText !== "ğŸ‰ Great job!") {
      speakGerman(wordText);
    }
  });

  document.getElementById('speakExample').addEventListener('click', () => {
    const exampleText = exampleEl.textContent || exampleEl.innerText;
    if (exampleText) {
      // Extract just the German part (line with ğŸ‡©ğŸ‡ª flag)
      const germanMatch = exampleText.match(/ğŸ‡©ğŸ‡ª\s*(.+?)(?:ğŸ‡¬ğŸ‡§|$)/);
      const germanPart = germanMatch ? germanMatch[1].trim() : exampleText.split('ğŸ‡¬ğŸ‡§')[0].replace('ğŸ‡©ğŸ‡ª', '').trim();
      if (germanPart) {
        speakGerman(germanPart);
      }
    }
  });

  // ========================================
  // INITIALIZE VOCABULARY APP
  // ========================================
  async function initVocab() {
    try {
      // Load vocabulary from JSON
      await vocabularyService.loadVocabulary();
      allWords = vocabularyService.getAllWords();

      // Select today's words using spaced repetition
      todayWords = selectTodayWords(allWords);

      if (todayWords.length === 0) {
        wordEl.textContent = "ğŸ‰ All done for today!";
        translationEl.textContent = "Come back tomorrow for more words";
        exampleEl.textContent = "";
        btnForgot.disabled = true;
        btnKnew.disabled = true;
        document.getElementById('speakWord').style.display = 'none';
        document.getElementById('speakExample').style.display = 'none';
        return;
      }

      // Update UI
      totalWordsEl.textContent = todayWords.length;
      cardTotalEl.textContent = todayWords.length;

      // Render first card
      renderCard();

    } catch (error) {
      console.error("Failed to load vocabulary:", error);
      wordEl.textContent = "Error loading vocabulary";
      translationEl.textContent = "Please refresh the page";
    }
  }

  // Start the app
  initVocab();
</script>
</body>
</html>
