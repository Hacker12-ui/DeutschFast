<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Progress - DeutschFast</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Global styles -->
  <link rel="stylesheet" href="css/style.css" />
  <!-- Page-specific styles -->
  <link rel="stylesheet" href="css/progress.css" />
</head>
<body>
  <div class="page progress-page">
    <!-- Header -->
    <header class="header">
      <div class="logo">DeutschFast</div>
      <nav class="nav-links">
        <a href="dashboard.html">Dashboard</a>
        <a href="courses.html">Courses</a>
        <a href="vocab.html">Vocab</a>
        <a href="#">Profile</a>
        <a href="login.html" class="nav-link logout-link">Log out</a>
      </nav>
    </header>

    <!-- Main content -->
    <main class="progress-main">
      <!-- Page Title -->
      <section class="progress-hero">
        <h1 class="progress-title">Your Progress</h1>
        <p class="progress-subtitle">See how far your German has come.</p>
      </section>

      <!-- Overall Progress & Study Stats Grid -->
      <div class="progress-top-grid">
        <!-- Overall Progress Card -->
        <article class="progress-card overall-card">
          <div class="level-badge" id="level-badge">A1</div>
          <h2 class="card-heading">Overall Progress</h2>
          <div class="progress-bar-wrap">
            <div class="progress-bar">
              <div class="progress-fill" id="overall-progress-fill" style="width: 0%;"></div>
            </div>
            <span class="progress-percent" id="overall-progress-percent">0% complete</span>
          </div>
          <p class="progress-message" id="progress-message">Start your first lesson to track progress.</p>
        </article>

        <!-- Study Stats Card -->
        <article class="progress-card stats-card">
          <h2 class="card-heading">Study Stats</h2>
          <div class="stats-grid">
            <div class="stat-item">
              <div class="stat-number" id="words-learned">0</div>
              <div class="stat-label">Words learned</div>
            </div>
            <div class="stat-item">
              <div class="stat-number" id="days-studied">0</div>
              <div class="stat-label">Days studied</div>
            </div>
            <div class="stat-item">
              <div class="stat-number" id="current-streak">0</div>
              <div class="stat-label">Current streak</div>
            </div>
            <div class="stat-item">
              <div class="stat-number" id="lessons-completed">0</div>
              <div class="stat-label">Lessons completed</div>
            </div>
          </div>
        </article>
      </div>

      <!-- Skill Breakdown Section -->
      <section class="skills-section">
        <h2 class="section-heading">Skill Breakdown</h2>
        <div class="skills-grid">
          <!-- Listening Skill -->
          <article class="progress-card skill-card">
            <div class="skill-header">
              <svg class="skill-icon" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 18v-6a9 9 0 0 1 18 0v6"></path>
                <path d="M21 19a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h3zM3 19a2 2 0 0 0 2 2h1a2 2 0 0 0 2-2v-3a2 2 0 0 0-2-2H3z"></path>
              </svg>
              <span class="skill-name">Listening</span>
            </div>
            <div class="skill-progress-wrap">
              <div class="progress-bar">
                <div class="progress-fill" id="listening-fill" style="width: 0%;"></div>
              </div>
              <span class="skill-percent" id="listening-percent">0%</span>
            </div>
          </article>

          <!-- Reading Skill -->
          <article class="progress-card skill-card">
            <div class="skill-header">
              <svg class="skill-icon" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
              </svg>
              <span class="skill-name">Reading</span>
            </div>
            <div class="skill-progress-wrap">
              <div class="progress-bar">
                <div class="progress-fill" id="reading-fill" style="width: 0%;"></div>
              </div>
              <span class="skill-percent" id="reading-percent">0%</span>
            </div>
          </article>

          <!-- Speaking Skill -->
          <article class="progress-card skill-card">
            <div class="skill-header">
              <svg class="skill-icon" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
              </svg>
              <span class="skill-name">Speaking</span>
            </div>
            <div class="skill-progress-wrap">
              <div class="progress-bar">
                <div class="progress-fill" id="speaking-fill" style="width: 0%;"></div>
              </div>
              <span class="skill-percent" id="speaking-percent">0%</span>
            </div>
          </article>

          <!-- Writing Skill -->
          <article class="progress-card skill-card">
            <div class="skill-header">
              <svg class="skill-icon" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
              </svg>
              <span class="skill-name">Writing</span>
            </div>
            <div class="skill-progress-wrap">
              <div class="progress-bar">
                <div class="progress-fill" id="writing-fill" style="width: 0%;"></div>
              </div>
              <span class="skill-percent" id="writing-percent">0%</span>
            </div>
          </article>
        </div>
      </section>

      <!-- CTA Button -->
      <div class="progress-cta">
        <button class="btn btn-primary btn-cta" id="continue-btn" onclick="continueLesson()">
          Continue today's lesson
        </button>
      </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
      <div>DeutschFast</div>
      <div class="footer-links">
        <a href="#">Contact</a>
        <a href="#">Privacy Policy</a>
        <a href="#">Terms of Use</a>
      </div>
    </footer>
  </div>

  <!-- Dynamic Progress Script -->
  <script>
    // ========================================
    // LOAD PROGRESS DATA
    // ========================================

    // Get module progress from localStorage
    function getModuleProgress() {
      const saved = localStorage.getItem('moduleProgress');
      return saved ? JSON.parse(saved) : {};
    }

    // Get vocab progress from localStorage
    function getVocabProgress() {
      const saved = localStorage.getItem('wordProgress');
      return saved ? JSON.parse(saved) : {};
    }

    // Calculate overall statistics
    function calculateStats() {
      const moduleProgress = getModuleProgress();
      const vocabProgress = getVocabProgress();

      // Total lessons completed across all modules
      let totalLessonsCompleted = 0;
      Object.values(moduleProgress).forEach(module => {
        totalLessonsCompleted += module.completedLessons || 0;
      });

      // Total lessons available (5 modules Ã— 5 lessons = 25)
      const totalLessons = 25;

      // Overall progress percentage
      const overallPercent = Math.round((totalLessonsCompleted / totalLessons) * 100);

      // Vocab stats
      const vocabWords = Object.keys(vocabProgress).length;
      const masteredWords = Object.values(vocabProgress).filter(w => w.level === 5).length;

      // Calculate days studied (simple version - count unique dates in future can track actual dates)
      const daysStudied = totalLessonsCompleted > 0 ? Math.max(1, Math.ceil(totalLessonsCompleted / 2)) : 0;

      // Current streak (simplified - in future track actual consecutive days)
      const currentStreak = daysStudied > 0 ? Math.min(daysStudied, 7) : 0;

      // Skill breakdown (each skill = 25% of each lesson)
      const listeningPercent = overallPercent;
      const readingPercent = overallPercent;
      const speakingPercent = Math.max(0, overallPercent - 5); // Slightly lower
      const writingPercent = Math.max(0, overallPercent - 10); // Slightly lower

      return {
        totalLessonsCompleted,
        totalLessons,
        overallPercent,
        vocabWords,
        masteredWords,
        daysStudied,
        currentStreak,
        listeningPercent,
        readingPercent,
        speakingPercent,
        writingPercent
      };
    }

    // Render progress page
    function renderProgress() {
      const stats = calculateStats();

      // Overall Progress
      document.getElementById('overall-progress-fill').style.width = stats.overallPercent + '%';
      document.getElementById('overall-progress-percent').textContent = stats.overallPercent + '% complete';

      // Progress message
      if (stats.overallPercent === 0) {
        document.getElementById('progress-message').textContent = 'Start your first lesson to track progress.';
      } else if (stats.overallPercent < 100) {
        const lessonsLeft = stats.totalLessons - stats.totalLessonsCompleted;
        const daysEstimate = Math.ceil(lessonsLeft / 2);
        document.getElementById('progress-message').textContent = 
          `You're on track to finish A1 in ${daysEstimate} days.`;
      } else {
        document.getElementById('progress-message').textContent = 'Congratulations! You completed A1!';
        document.getElementById('level-badge').textContent = 'A2';
      }

      // Study Stats
      document.getElementById('words-learned').textContent = stats.vocabWords;
      document.getElementById('days-studied').textContent = stats.daysStudied;
      document.getElementById('current-streak').textContent = stats.currentStreak;
      document.getElementById('lessons-completed').textContent = stats.totalLessonsCompleted;

      // Skill Breakdown
      document.getElementById('listening-fill').style.width = stats.listeningPercent + '%';
      document.getElementById('listening-percent').textContent = stats.listeningPercent + '%';

      document.getElementById('reading-fill').style.width = stats.readingPercent + '%';
      document.getElementById('reading-percent').textContent = stats.readingPercent + '%';

      document.getElementById('speaking-fill').style.width = stats.speakingPercent + '%';
      document.getElementById('speaking-percent').textContent = stats.speakingPercent + '%';

      document.getElementById('writing-fill').style.width = stats.writingPercent + '%';
      document.getElementById('writing-percent').textContent = stats.writingPercent + '%';
    }

    // Continue to next lesson
    function continueLesson() {
      const moduleProgress = getModuleProgress();
      
      // Find first incomplete module
      const modules = [
        { id: 'basics-introductions', totalLessons: 5 },
        { id: 'family-people', totalLessons: 5 },
        { id: 'daily-life-routine', totalLessons: 5 },
        { id: 'food-shopping', totalLessons: 5 },
        { id: 'around-city', totalLessons: 5 }
      ];

      for (let i = 0; i < modules.length; i++) {
        const module = modules[i];
        const progress = moduleProgress[module.id] || { completedLessons: 0 };
        
        if (progress.completedLessons < module.totalLessons) {
          // Found incomplete module - go to next lesson
          const nextLessonNum = progress.completedLessons + 1;
          const lessonId = `lesson-${i + 1}-${nextLessonNum}`;
          window.location.href = `lesson.html?id=${lessonId}`;
          return;
        }
      }

      // All lessons completed
      alert('Congratulations! You completed all A1 lessons! ðŸŽ‰');
      window.location.href = 'courses.html';
    }

    // Initialize progress page
    renderProgress();
  </script>
  <script type="module">
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { auth } from "./js/firebase.js";

  onAuthStateChanged(auth, (user) => {
    if (!user) window.location.replace("login.html");
  });
</script>
</body>
</html>
