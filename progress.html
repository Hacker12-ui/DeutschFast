<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Progress - DeutschFast</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="css/progress.css" />
</head>
<body>
  <div class="page progress-page">
    <header class="header">
      <div class="logo">DeutschFast</div>
      <nav class="nav-links">
        <a href="dashboard.html">Dashboard</a>
        <a href="courses.html">Courses</a>
        <a href="vocab.html">Vocab</a>
        <a href="#">Profile</a>
        <a href="#" id="logoutBtn" class="nav-link logout-link">Log out</a>
      </nav>
    </header>

    <main class="progress-main">
      <section class="progress-hero">
        <h1 class="progress-title">Your Progress</h1>
        <p class="progress-subtitle">See how far your German has come.</p>
      </section>

      <div class="progress-top-grid">
        <article class="progress-card overall-card">
          <div class="level-badge" id="level-badge">A1</div>
          <h2 class="card-heading">Overall Progress</h2>
          <div class="progress-bar-wrap">
            <div class="progress-bar">
              <div class="progress-fill" id="overall-progress-fill" style="width: 0%;"></div>
            </div>
            <span class="progress-percent" id="overall-progress-percent">0% complete</span>
          </div>
          <p class="progress-message" id="progress-message">Start your first lesson to track progress.</p>
        </article>

        <article class="progress-card stats-card">
          <h2 class="card-heading">Study Stats</h2>
          <div class="stats-grid">
            <div class="stat-item">
              <div class="stat-number" id="words-learned">0</div>
              <div class="stat-label">Words learned</div>
            </div>
            <div class="stat-item">
              <div class="stat-number" id="days-studied">0</div>
              <div class="stat-label">Days studied</div>
            </div>
            <div class="stat-item">
              <div class="stat-number" id="current-streak">0</div>
              <div class="stat-label">Current streak</div>
            </div>
            <div class="stat-item">
              <div class="stat-number" id="lessons-completed">0</div>
              <div class="stat-label">Lessons completed</div>
            </div>
          </div>
        </article>
      </div>

      <section class="skills-section">
        <h2 class="section-heading">Skill Breakdown</h2>
        <div class="skills-grid">
          <article class="progress-card skill-card">
            <div class="skill-header">
              <svg class="skill-icon" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 18v-6a9 9 0 0 1 18 0v6"></path>
                <path d="M21 19a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h3zM3 19a2 2 0 0 0 2 2h1a2 2 0 0 0 2-2v-3a2 2 0 0 0-2-2H3z"></path>
              </svg>
              <span class="skill-name">Listening</span>
            </div>
            <div class="skill-progress-wrap">
              <div class="progress-bar">
                <div class="progress-fill" id="listening-fill" style="width: 0%;"></div>
              </div>
              <span class="skill-percent" id="listening-percent">0%</span>
            </div>
          </article>

          <article class="progress-card skill-card">
            <div class="skill-header">
              <svg class="skill-icon" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
              </svg>
              <span class="skill-name">Reading</span>
            </div>
            <div class="skill-progress-wrap">
              <div class="progress-bar">
                <div class="progress-fill" id="reading-fill" style="width: 0%;"></div>
              </div>
              <span class="skill-percent" id="reading-percent">0%</span>
            </div>
          </article>

          <article class="progress-card skill-card">
            <div class="skill-header">
              <svg class="skill-icon" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
              </svg>
              <span class="skill-name">Speaking</span>
            </div>
            <div class="skill-progress-wrap">
              <div class="progress-bar">
                <div class="progress-fill" id="speaking-fill" style="width: 0%;"></div>
              </div>
              <span class="skill-percent" id="speaking-percent">0%</span>
            </div>
          </article>

          <article class="progress-card skill-card">
            <div class="skill-header">
              <svg class="skill-icon" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
              </svg>
              <span class="skill-name">Writing</span>
            </div>
            <div class="skill-progress-wrap">
              <div class="progress-bar">
                <div class="progress-fill" id="writing-fill" style="width: 0%;"></div>
              </div>
              <span class="skill-percent" id="writing-percent">0%</span>
            </div>
          </article>
        </div>
      </section>

      <div class="progress-cta">
        <button class="btn btn-primary btn-cta" id="continue-btn" onclick="continueLesson()">
          Continue today's lesson
        </button>
      </div>
    </main>

    <footer class="footer">
      <div>DeutschFast</div>
      <div class="footer-links">
        <a href="#">Contact</a>
        <a href="#">Privacy Policy</a>
        <a href="#">Terms of Use</a>
      </div>
    </footer>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD3siGsp0yRzdypymFTUWKLbMDQMJ7VBds",
      authDomain: "deutschfast-prod.firebaseapp.com",
      projectId: "deutschfast-prod",
      storageBucket: "deutschfast-prod.firebasestorage.app",
      messagingSenderId: "505440472870",
      appId: "1:505440472870:web:e438916302530e2d5f3be7"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // Auth Guard
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        window.location.replace("login.html");
      }
    });

    // Logout Functionality
    const logoutBtn = document.getElementById("logoutBtn");
    if (logoutBtn) {
      logoutBtn.addEventListener("click", async (e) => {
        e.preventDefault();
        try {
          await signOut(auth);
          window.location.replace("login.html");
        } catch (error) {
          console.error("Logout Error:", error);
        }
      });
    }
  </script>

  <script>
    function getModuleProgress() {
      const saved = localStorage.getItem('moduleProgress');
      return saved ? JSON.parse(saved) : {};
    }

    function getVocabProgress() {
      const saved = localStorage.getItem('wordProgress');
      return saved ? JSON.parse(saved) : {};
    }

    function calculateStats() {
      const moduleProgress = getModuleProgress();
      const vocabProgress = getVocabProgress();

      let totalLessonsCompleted = 0;
      Object.values(moduleProgress).forEach(module => {
        totalLessonsCompleted += module.completedLessons || 0;
      });

      const totalLessons = 25;
      const overallPercent = Math.round((totalLessonsCompleted / totalLessons) * 100);
      const vocabWords = Object.keys(vocabProgress).length;
      const daysStudied = totalLessonsCompleted > 0 ? Math.max(1, Math.ceil(totalLessonsCompleted / 2)) : 0;
      const currentStreak = daysStudied > 0 ? Math.min(daysStudied, 7) : 0;

      return {
        totalLessonsCompleted,
        totalLessons,
        overallPercent,
        vocabWords,
        daysStudied,
        currentStreak,
        listeningPercent: overallPercent,
        readingPercent: overallPercent,
        speakingPercent: Math.max(0, overallPercent - 5),
        writingPercent: Math.max(0, overallPercent - 10)
      };
    }

    function renderProgress() {
      const stats = calculateStats();

      document.getElementById('overall-progress-fill').style.width = stats.overallPercent + '%';
      document.getElementById('overall-progress-percent').textContent = stats.overallPercent + '% complete';

      if (stats.overallPercent === 0) {
        document.getElementById('progress-message').textContent = 'Start your first lesson to track progress.';
      } else if (stats.overallPercent < 100) {
        const lessonsLeft = stats.totalLessons - stats.totalLessonsCompleted;
        const daysEstimate = Math.ceil(lessonsLeft / 2);
        document.getElementById('progress-message').textContent = 
          `You're on track to finish A1 in ${daysEstimate} days.`;
      } else {
        document.getElementById('progress-message').textContent = 'Congratulations! You completed A1!';
        document.getElementById('level-badge').textContent = 'A2';
      }

      document.getElementById('words-learned').textContent = stats.vocabWords;
      document.getElementById('days-studied').textContent = stats.daysStudied;
      document.getElementById('current-streak').textContent = stats.currentStreak;
      document.getElementById('lessons-completed').textContent = stats.totalLessonsCompleted;

      document.getElementById('listening-fill').style.width = stats.listeningPercent + '%';
      document.getElementById('listening-percent').textContent = stats.listeningPercent + '%';
      document.getElementById('reading-fill').style.width = stats.readingPercent + '%';
      document.getElementById('reading-percent').textContent = stats.readingPercent + '%';
      document.getElementById('speaking-fill').style.width = stats.speakingPercent + '%';
      document.getElementById('speaking-percent').textContent = stats.speakingPercent + '%';
      document.getElementById('writing-fill').style.width = stats.writingPercent + '%';
      document.getElementById('writing-percent').textContent = stats.writingPercent + '%';
    }

    function continueLesson() {
      const moduleProgress = getModuleProgress();
      const modules = [
        { id: 'basics-introductions', totalLessons: 5 },
        { id: 'family-people', totalLessons: 5 },
        { id: 'daily-life-routine', totalLessons: 5 },
        { id: 'food-shopping', totalLessons: 5 },
        { id: 'around-city', totalLessons: 5 }
      ];

      for (let i = 0; i < modules.length; i++) {
        const module = modules[i];
        const progress = moduleProgress[module.id] || { completedLessons: 0 };
        
        if (progress.completedLessons < module.totalLessons) {
          const nextLessonNum = progress.completedLessons + 1;
          const lessonId = `lesson-${i + 1}-${nextLessonNum}`;
          window.location.href = `lesson.html?id=${lessonId}`;
          return;
        }
      }

      alert('Congratulations! You completed all A1 lessons! ðŸŽ‰');
      window.location.href = 'courses.html';
    }

    renderProgress();
  </script>
</body>
</html>