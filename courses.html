<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Courses - DeutschFast</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="css/courses.css" />
</head>
<body>
  <div class="page courses-page">
    <header class="header">
  <div class="logo">DeutschFast</div>
  <nav class="nav-links">
    <a href="dashboard.html">Dashboard</a>
    <a href="courses.html" class="nav-link active">Courses</a>
    <a href="lesson.html">Lessons</a>
    <a href="vocab.html">Vocab</a>
    <a href="#">Profile</a>
    <a href="#" id="logoutBtn" class="nav-link logout-link">Log out</a>
    </nav>
</header>
    <main class="courses-main">
      <section class="courses-hero">
        <h1 class="courses-title" id="welcome-title">Courses</h1>
        <p class="courses-subtitle">Choose your level and start learning.</p>
      </section>

      <section class="level-selector">
        <button class="level-pill level-pill-active" data-level="A1">A1</button>
        <button class="level-pill" data-level="A2">A2</button>
        <button class="level-pill" data-level="B1">B1</button>
        <button class="level-pill" data-level="B2">B2</button>
      </section>

      <section class="modules-grid" id="modules-container">
        </section>

      <section class="courses-info">
        <h3 class="courses-info-title">How courses work</h3>
        <p class="courses-info-text">
          Each module has short lessons with listening, reading, speaking, and
          writing. Start at A1 if you are completely new to German.
        </p>
      </section>
    </main>

    <footer class="footer">
      <div>DeutschFast</div>
      <div class="footer-links">
        <a href="#">Contact</a>
        <a href="#">Privacy Policy</a>
        <a href="#">Terms of Use</a>
      </div>
    </footer>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD3siGsp0yRzdypymFTUWKLbMDQMJ7VBds",
      authDomain: "deutschfast-prod.firebaseapp.com",
      projectId: "deutschfast-prod",
      storageBucket: "deutschfast-prod.firebasestorage.app",
      messagingSenderId: "505440472870",
      appId: "1:505440472870:web:e438916302530e2d5f3be7"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // 1. Auth Guard: Check if user is logged in
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        // Use replace to prevent back-button loops
        window.location.replace("login.html");
      } else {
        const title = document.getElementById('welcome-title');
        if (user.displayName) {
          title.textContent = `Willkommen, ${user.displayName.split(' ')[0]}!`;
        }
      }
    });

    // 2. Logout functionality
    const logoutBtn = document.getElementById("logoutBtn");
    if (logoutBtn) {
      logoutBtn.addEventListener("click", async (e) => {
        e.preventDefault();
        try {
          await signOut(auth);
          window.location.replace("login.html");
        } catch (error) {
          console.error("Logout Error:", error);
        }
      });
    }
  </script>

  <script>
    // ========================================
    // MODULE LOADER & FILTERING LOGIC
    // ========================================

    let allModules = [];
    let currentLevel = "A1"; // Default to A1 on load
    const iconColors = ['green', 'orange', 'yellow', 'red', 'purple'];

    function getUserProgress() {
      const saved = localStorage.getItem('moduleProgress');
      return saved ? JSON.parse(saved) : {};
    }

    // 1. Initialize Buttons
    // This attaches click events to A1, A2, B1, B2 buttons
    document.querySelectorAll('.level-pill').forEach(button => {
      button.addEventListener('click', (e) => {
        // Remove active class from all buttons
        document.querySelectorAll('.level-pill').forEach(btn => btn.classList.remove('level-pill-active'));
        
        // Add active class to clicked button
        e.target.classList.add('level-pill-active');
        
        // Update current level variable
        currentLevel = e.target.dataset.level;
        
        // Re-render the grid with the new filter
        renderModules();
      });
    });

    async function loadModules() {
      try {
        const response = await fetch('data/modules.json');
        const data = await response.json();
        allModules = data.modules;
        renderModules(); // Initial render
      } catch (error) {
        console.error('Error loading modules:', error);
        document.getElementById('modules-container').innerHTML = 
          '<p style="text-align: center; color: #666;">Error loading courses. Please refresh the page.</p>';
      }
    }

    function renderModules() {
      const container = document.getElementById('modules-container');
      const progress = getUserProgress();
      
      container.innerHTML = ''; 

      // FILTERING HAPPENS HERE
      // We only loop through modules that match 'currentLevel'
      const filteredModules = allModules.filter(module => module.level === currentLevel);

      if (filteredModules.length === 0) {
        container.innerHTML = `<p style="text-align: center; width: 100%; color: #888; margin-top: 30px;">
          No courses available for ${currentLevel} yet. Coming soon!
        </p>`;
        return;
      }

      filteredModules.forEach((module, index) => {
        const moduleProgress = progress[module.id] || { completedLessons: 0 };
        const completed = moduleProgress.completedLessons || 0;
        const buttonText = completed > 0 ? 'Continue' : 'Start';
        const colorClass = iconColors[index % iconColors.length];

        const card = `
          <article class="module-card">
            <div class="module-top">
              <div class="module-icon module-icon-${colorClass}">${module.icon}</div>
              <span class="module-tag">${module.level} Â· ${module.category}</span>
            </div>
            <h2 class="module-title">${module.title}</h2>
            <p class="module-text">${module.description}</p>
            <p class="module-progress">${completed} / ${module.totalLessons} lessons completed</p>
            <button class="btn btn-primary btn-module" onclick="startModule('${module.id}')">
              ${buttonText}
            </button>
          </article>
        `;
        container.innerHTML += card;
      });
    }

    function startModule(moduleId) {
      const module = allModules.find(m => m.id === moduleId);
      if (!module) {
        alert('Module not found');
        return;
      }

      const progress = getUserProgress();
      const moduleProgress = progress[moduleId] || { completedLessons: 0 };
      const nextLessonIndex = moduleProgress.completedLessons || 0;
      
      // Safety check if user finished all lessons
      if (nextLessonIndex >= module.lessons.length) {
         // Optionally send them to the last lesson or a completion page
         // For now, let's send them to the last lesson
         const lastLessonId = module.lessons[module.lessons.length - 1];
         window.location.href = `lesson.html?id=${lastLessonId}`;
         return;
      }

      const nextLessonId = module.lessons[nextLessonIndex];
      window.location.href = `lesson.html?id=${nextLessonId}`;
    }

    loadModules();
  </script>
</body>
</html>